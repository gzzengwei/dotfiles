#!/usr/bin/env bash
set -euo pipefail

PROFILE_DIR="${CLAUDE_PROFILE_DIR:-$HOME/.config/claude/profiles.d}"
DEFAULT_PROFILE="bigmodel"

# Load .envrc from the calling directory if it exists
CALLING_DIR="$(pwd)"
_envrc_vars=()
if [[ -f "${CALLING_DIR}/.envrc" ]]; then
  echo "cc: loading .envrc from ${CALLING_DIR}"
  # Collect variable names from .envrc (handles both 'VAR=value' and 'export VAR=value')
  mapfile -t _envrc_vars < <(grep -E '^(export )?[A-Za-z_][A-Za-z0-9_]*=' "${CALLING_DIR}/.envrc" | sed 's/^export //' | sed 's/=.*//' | xargs -n1 printf '%s\n' | sort -u)
  set -a
  # shellcheck disable=SC1090
  source "${CALLING_DIR}/.envrc"
  set +a
fi

usage() {
  echo "Usage:"
  echo "  cc [-p profile] [claude args...]"
  echo "  cc --list"
  echo "Examples:"
  echo "  cc --list"
  echo "  cc -p kimi \"Hello\""
  echo "  cc \"Hello (uses default: $DEFAULT_PROFILE)\""
  exit 1
}

profile=""
args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
  -p | --profile)
    profile="$2"
    shift 2
    ;;
  --list | -l)
    ls -1 "${PROFILE_DIR}"/*.env 2>/dev/null | sed 's#.*/##; s#\.env$##'
    exit 0
    ;;
  -h | --help) usage ;;
  *)
    args+=("$1")
    shift
    ;;
  esac
done

# If no profile specified, use default
if [[ -z "$profile" ]]; then
  profile="$DEFAULT_PROFILE"
  echo "cc: no profile specified, using default -> $profile"
else
  echo "cc: using profile -> $profile"
fi

file="${PROFILE_DIR}/${profile}.env"
if [[ ! -f "$file" ]]; then
  echo "cc: profile not found: $profile"
  usage
fi

# Collect only the variables defined in the profile (names before '=').
mapfile -t _cc_vars < <(grep -E '^[A-Za-z_][A-Za-z0-9_]*=' "$file" | sed 's/=.*//' | xargs -n1 printf '%s\n' | sort -u)

set -a
# shellcheck disable=SC1090
source "$file"
set +a

_cc_env=()
# Add variables from profile
for v in "${_cc_vars[@]}"; do
  if [[ -n "${!v-}" ]]; then
    _cc_env+=("$v=${!v}")
  fi
done
# Add variables from .envrc
for v in "${_envrc_vars[@]}"; do
  if [[ -n "${!v-}" ]]; then
    _cc_env+=("$v=${!v}")
  fi
done

echo "claude bin: $(which claude)"

exec env -i \
  PATH="$PATH" \
  HOME="$HOME" \
  SHELL="$SHELL" \
  USER="$USER" \
  TERM="$TERM" \
  COLORTERM="${COLORTERM-}" \
  LANG="${LANG-}" \
  LC_ALL="${LC_ALL-}" \
  CLAUDE_PROFILE="$profile" \
  "${_cc_env[@]}" \
  claude "${args[@]}"
