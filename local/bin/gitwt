#!/bin/bash

# Function to get the git project root directory
get_git_root() {
  git rev-parse --show-toplevel
}

# Function to get project name from git root path
get_project_name() {
  local git_root="$1"
  basename "$git_root"
}

# Function to setup worktree folder path
setup_worktree_folder() {
  local git_root=$(get_git_root)
  local project_name=$(get_project_name "$git_root")
  local parent_dir=$(dirname "$git_root")
  echo "${parent_dir}/${project_name}-worktree"
}

# Set the parent directory for worktrees based on current project
GIT_WORKTREE_FOLDER=$(setup_worktree_folder)

usage() {
  echo "Usage: gitwt <action> <branch_name> [worktree_folder]"
  echo "Manage git worktrees"
  echo ""
  echo "Actions:"
  echo "  add     Create a new worktree for specified branch"
  echo "  track   Create a new worktree tracking a remote branch"
  echo "  delete  Remove a worktree and its directory"
  echo ""
  echo "Arguments:"
  echo "  branch_name      Name of the git branch (can include prefix, e.g., feature/foo)"
  echo "  worktree_folder  Optional: Custom folder name (defaults to branch name)"
  echo ""
  echo "Worktree Location:"
  echo "  Worktrees will be created under: $GIT_WORKTREE_FOLDER/<branch_name>"
  echo "  For branches with prefix (e.g., feature/foo), appropriate subdirectories"
  echo "  will be created automatically"
  exit 1
}

# Check if we're in a git repository
check_git_repo() {
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
  fi
}

# Create directory if it doesn't exist
ensure_directory() {
  if [ ! -d "$1" ]; then
    mkdir -p "$1"
    echo "Created directory: $1"
  fi
}

# Get the full worktree path
get_worktree_path() {
  local branch_name="$1"
  local custom_folder="$2"
  local folder_name="${custom_folder:-$branch_name}"

  # If using the branch name and it contains slashes, ensure parent directories exist
  if [ -z "$custom_folder" ] && [[ "$branch_name" == */* ]]; then
    local branch_dirname=$(dirname "$folder_name")
    ensure_directory "${GIT_WORKTREE_FOLDER}/${branch_dirname}"
  fi

  echo "${GIT_WORKTREE_FOLDER}/${folder_name}"
}

# Add a new worktree
add_worktree() {
  local branch_name="$1"
  local worktree_path="$2"

  # Check if branch exists
  if ! git show-ref --verify --quiet "refs/heads/$branch_name"; then
    # Create new branch if it doesn't exist
    git branch "$branch_name"
  fi

  # Ensure the parent directory exists
  ensure_directory "$(dirname "$worktree_path")"

  git worktree add "$worktree_path" "$branch_name"
  echo "Worktree created at: $worktree_path"
}

# Track a remote branch
track_worktree() {
  local branch_name="$1"
  local worktree_path="$2"

  # Make sure the remote branch exists on origin
  if ! git ls-remote --exit-code --heads origin "$branch_name" >/dev/null 2>&1; then
    echo "Error: Remote branch origin/$branch_name does not exist"
    exit 1
  fi

  # Ensure the parent directory exists (multi-level OK)
  ensure_directory "$(dirname "$worktree_path")"

  # If a local branch already exists, just use it; otherwise create it to track the remote
  if git show-ref --verify --quiet "refs/heads/$branch_name"; then
    git worktree add "$worktree_path" "$branch_name"
  else
    # Create a local branch from the remote ref (works with deep paths)
    git fetch origin "$branch_name:$branch_name"
    git worktree add "$worktree_path" "$branch_name"
  fi

  echo "Worktree created at: $worktree_path"
}

# Delete a worktree
delete_worktree() {
  local worktree_path="$1"

  if [ ! -d "$worktree_path" ]; then
    echo "Error: Worktree directory does not exist: $worktree_path"
    exit 1
  fi

  echo "Removing git worktree..."
  git worktree remove -f "$worktree_path"

  # Check if the directory still exists (in case it wasn't fully removed)
  if [ -d "$worktree_path" ]; then
    echo "Removing remaining directory..."
    rm -rf "$worktree_path"
  fi

  echo "Worktree and directory removed: $worktree_path"

  # Clean up empty parent directories
  local current_dir="$(dirname "$worktree_path")"
  while [ "$current_dir" != "$GIT_WORKTREE_FOLDER" ]; do
    if [ -z "$(ls -A "$current_dir")" ]; then
      echo "Removing empty directory: $current_dir"
      rm -rf "$current_dir"
      current_dir="$(dirname "$current_dir")"
    else
      break
    fi
  done

  # Check if the worktree parent directory is empty
  if [ -z "$(ls -A "$GIT_WORKTREE_FOLDER")" ]; then
    echo "Removing empty worktree parent directory..."
    rm -rf "$GIT_WORKTREE_FOLDER"
    echo "Removed empty directory: $GIT_WORKTREE_FOLDER"
  fi
}

# Main script

# Check for minimum required arguments
if [ $# -lt 2 ]; then
  usage
fi

action="$1"
branch_name="$2"
custom_folder="$3"

# Validate inputs
check_git_repo

# Get the worktree path
worktree_path=$(get_worktree_path "$branch_name" "$custom_folder")

# Process the action
case "$action" in
"add")
  add_worktree "$branch_name" "$worktree_path"
  ;;
"track")
  track_worktree "$branch_name" "$worktree_path"
  ;;
"delete")
  delete_worktree "$worktree_path"
  ;;
*)
  echo "Error: Invalid action '$action'"
  usage
  ;;
esac
